
{%- liquid
  assign calculated_total_price = 0
  for line_item in cart.items
    if line_item.requires_shipping
      assign calculated_total_price = calculated_total_price | plus: line_item.final_line_price
    endif
  endfor
  # We have to remove the cart level discount from the calculated amount
  assign total_cart_discount = 0
  for discount_application in cart.cart_level_discount_applications
    assign total_cart_discount = total_cart_discount | plus: discount_application.total_allocated_amount
  endfor
  assign calculated_total_price = calculated_total_price | minus: total_cart_discount
-%}
{%- if cart.requires_shipping -%}
  <free-shipping-bar
    class="free-shipping-bar"
    threshold="{{ settings.cart_free_shipping_threshold | times: 100.0 }}"
    total-price="{{ calculated_total_price }}"
    reached-message="{{ 'cart.free_shipping_bar.limit_reached_html' | t | escape }}"
    unreached-message="{{ 'cart.free_shipping_bar.limit_unreached_html' | t | escape }}"
  >
    <span>&nbsp;</span>
    <progress-bar style="
       --progress: 1;
       position: relative;
       display: flex;
       flex-direction: row;
       align-items: center;
      ">
      <div id="progress-container">
        <div id="progress-bar">
          <div id="progress-fill">
            <div id="progress-truck">
              {%- render 'icon' with 'picto-truck', width: '20px', height: '20px', stroke_width: '1.5' -%}
            </div>
          </div>
        </div>
      </div>
    </progress-bar>
  </free-shipping-bar>
{%- endif -%}
<style>
    #progress-container {
      width: 100%;
      background-color: #f2f2f2;
      border-radius: var(--rounded);      
    }
    #progress-bar {
      width: 100%;
      height: 8px;
      background-color: #f2f2f2;
      position: relative;
      border-radius: var(--rounded);
      z-index: 2;
    }
    @keyframes moveBackground {
      from { background-position: 0 0; }
      to { background-position: 400px 0; }
    }

    :root {
      --frete-gratis-color-rgb  : {{ settings.ship_primary_color | color_extract: 'red' }}, {{ settings.ship_primary_color | color_extract: 'green' }}, {{ settings.ship_primary_color | color_extract: 'blue' }};
    }
  
    #progress-fill {
      width: 100%;
      transition: 1s ease;
      height: 100%;
      background-image: repeating-linear-gradient(
          -45deg,
          rgba(var(--frete-gratis-color-rgb), .6),
          rgba(var(--frete-gratis-color-rgb), .6) 10px,
          rgba(var(--frete-gratis-color-rgb), 1) 10px,
          rgba(var(--frete-gratis-color-rgb), 1) 20px
        );
      animation: moveBackground 10s linear infinite; 
      position: relative;
      border-radius: var(--rounded);
      display: flex;
      flex-direction: row;
      align-items: center;
    }
    #progress-truck {
      background-color: #fff;
      padding: 5px;
      border: 1px solid {{ settings.ship_primary_color }};
      color: {{ settings.ship_primary_color }};
      width: 32px;
      height: 32px;
      border-radius: 50px;
      position: absolute;
      right: 0;
      z-index: 3;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: 1s ease;
    }
    #cart-drawer > div:nth-child(1) > div.cart-drawer__top > free-shipping-bar > span, #shopify-section-template--22241715552559__main > div > div > div > div.cart-header > free-shipping-bar > span {
      text-align: center;
      font-size: 18px;
    }

</style>
<script>
  let lastTotalPrice = 0;
  function updateTruckPosition() {
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const totalPrice = cart.total_price;
        if (totalPrice !== lastTotalPrice) {
          lastTotalPrice = totalPrice;
          const threshold = 30000.0;
          let progressWidth, truckPosition;
          if (totalPrice >= threshold) {
            progressWidth = 100;
            truckPosition = 100;
          } else {
            progressWidth = 80;
            truckPosition = 82;
          }
          const progressBarFill = document.getElementById('progress-fill');
          if (progressBarFill) {
            progressBarFill.style.width = `${progressWidth}%`;
          const truckContainer = document.querySelector('.container-truck');
                        truckContainer.style.width = `${truckPosition}%`;
          }
        }
      })
      .catch(error => console.error('Error fetching cart:', error));
  }
  document.addEventListener('DOMContentLoaded', updateTruckPosition);
  setInterval(updateTruckPosition, 3000);
</script>
